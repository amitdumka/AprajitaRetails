@page "/payroll/attendances"

@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.WebAssembly.Authentication
@using AprajitaRetails.Shared
@using AprajitaRetails.Shared.Models.Payroll
@using AprajitaRetails.AdminLte
@using AprajitaRetails.Helpers

@attribute [Authorize]
@inject NotificationService NotificationService
@inject NavigationManager NavigationManager
@inject SfDialogService DialogService
@inject HttpClient Http
@inject ClientSetting Settings
@inject DataHelper Helper

<ContentHeader>
    <Header>
        <Blazor.AdminLte.PageTitle Title=@Title />
    </Header>
</ContentHeader>

<ContentMain>

    @if (entities == null)
    {

        <p><em>Loading...</em></p>
    }
    else
    {
        <Row>
            <Card ToolOptions="new CardToolOptions {Collapsable = true,Maximizable=true }">
                <Title>
                    <CardTitle>@Title</CardTitle>

                </Title>
                <Header>
                    <CardTools>
                        <CustomTools>
                            <a class="btn btn-primary btn-xs btn" href="/payroll/attendances/edit/false">Add</a>
                        </CustomTools>
                    </CardTools>
                </Header>
                <Body>
                    <AprajitaRetails.AdminLte.Table.ATable Bordered=true Hover=true>
                        <TableHead>

                            <TableHeadCell>Date</TableHeadCell>
                            <TableHeadCell>Name</TableHeadCell>
                            <TableHeadCell>Time</TableHeadCell>
                            <TableHeadCell>Status</TableHeadCell>
                            <TableHeadCell>Remarks</TableHeadCell>
                            <TableHeadCell>     </TableHeadCell>
                        </TableHead>
                        <TableBody>

                            @foreach (var ent in entities)
                            {
                                <TableRow>
                                    @* <TableCell>@ent.AttendanceId</TableCell>*@
                                    <TableCell>@ent.OnDate.ToShortDateString()</TableCell>
                                    <TableCell>@StaffName(ent.EmployeeId)</TableCell>

                                    <TableCell>@ent.EntryTime</TableCell>

                                    <TableCell>@ent.Status</TableCell>
                                    <TableCell>@ent.Remarks</TableCell>
                                    @*<TableCell>@ent.StoreId</TableCell>*@
                                    <TableCell>
                                        <ActionMenu Link="/payroll/attendances" Id="@ent.AttendanceId" OnClickDelete="()=>ConfirmDelete(ent.AttendanceId)" />
                                    </TableCell>
                                </TableRow>
                            }
                        </TableBody>
                    </AprajitaRetails.AdminLte.Table.ATable>
                </Body>
            </Card>
        </Row>
    }

</ContentMain>

@code {

    private const string Title = "Attendances";
    private List<Attendance>? entities;
    // private Employee[]? employees;
    private List<Employee>? employees;

    private string StaffName(string id)
    {
        return employees != null ? employees.First(c => c.EmployeeId == id).StaffName : "";
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            if (!string.IsNullOrEmpty(Settings.StoreCode))
            {
                employees = await Helper.FetchAsync<Employee>($"Employees/ByStore?storeid={Settings.StoreCode}&isWorking=true", "");
                entities = await Helper.FetchAsync<Attendance>($"Attendances/ByStore?storeid={Settings.StoreCode}", "");

            }
            else { Helper.Msg("Error", "Store is not selected!, Kindly re-login!", true); }
        }
        catch (Exception exception)
        {
            Helper.Msg("Error", exception.Message, true);
        }
    }

    async void ConfirmDelete(string id)
    {

        var flag = await Helper.DeleteAsync("Attendances", "Attendance", id);
        if (flag)
        {
            entities.Remove(entities.First(c => c.AttendanceId == id));
            StateHasChanged();
            Helper.Msg("Delete", $"Attendance {id} is deleted");
            StateHasChanged();
        }


    }


}