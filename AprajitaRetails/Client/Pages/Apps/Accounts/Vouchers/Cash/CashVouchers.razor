@page "/vouchers/cash"

@using AprajitaRetails.Commons
@using AprajitaRetails.Shared.Models.Vouchers;
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.WebAssembly.Authentication
@using AprajitaRetails.Shared
@using AprajitaRetails.Client.Helpers
@using AprajitaRetails.Shared.ViewModels;

@attribute [Authorize]
@inject DataHelper Helper
@inject ClientSetting Setting
@inject NavigationManager NavigationManager

<ContentMain>
    <EntityList Title="@Title" BaseUrl=@PageUrl Loading=@Loading>
        <TableHead>
            <TableHeadCell>Type</TableHeadCell>
            <TableHeadCell>Date</TableHeadCell>
            <TableHeadCell>VoucherNo</TableHeadCell>
            <TableHeadCell>Party Name</TableHeadCell>
            <TableHeadCell>Particulars</TableHeadCell>
            <TableHeadCell>Amount</TableHeadCell>
            <TableHeadCell>Category</TableHeadCell>
            <TableHeadCell>Remarks</TableHeadCell>
            <TableHeadCell>Issued By</TableHeadCell>
            <TableHeadCell>Slip No</TableHeadCell>
            <TableHeadCell> </TableHeadCell>
        </TableHead>
        <TableBody>

            @foreach (var vch in vchlist)
            {
                <TableRow>
                    <TableCell>@vch.VoucherType</TableCell>
                    <TableCell>@vch.OnDate.ToShortDateString()</TableCell>
                    <TableCell>@vch.VoucherNumber</TableCell>
                    <TableCell>@vch.PartyName</TableCell>
                    <TableCell>@vch.Particulars</TableCell>
                    <TableCell>@vch.Amount</TableCell>
                    <TableCell>@ModeName(vch.TransactionId)</TableCell>
                    <TableCell>@vch.Remarks</TableCell>
                    <TableCell>@vch.EmployeeId</TableCell>
                    <TableCell>@vch.SlipNumber</TableCell>
                    <TableCell>
                        <AprajitaRetails.AdminLte.ActionMenu Link="/vouchers/cash" Id="@vch.VoucherNumber" />
                    </TableCell>
                </TableRow>
            }
        </TableBody>
    </EntityList>

</ContentMain>

@code {
    string Title = "Cash Vouchers";
    string PageUrl = "/vouchers/cash";
    bool Loading = true;

    private List<CashVoucher>? vchlist;
    private SelectOption[]? modeList;

    private string ModeName(string id)
    {
        return modeList.First(c => c.ID == id).Value;
    }

    async void ConfirmDelete(string id)
    {
        var flag = await Helper.DeleteAsync("CashVouchers", $"Cash Voucher:{vchlist.First(c => c.VoucherNumber == id).VoucherType.ToString()} ", id);

        if (flag)
        {
            vchlist.Remove(vchlist.First(c => c.VoucherNumber == id));
            StateHasChanged();
        }

    }
    protected override async Task OnInitializedAsync()
    {
        if (string.IsNullOrEmpty(Setting.StoreCode))
        {
            Helper.Msg("Error", "Select store!, Kindly re-login", true);
            return;
        }
        try
        {
            vchlist = await Helper.FetchAsync<CashVoucher>($"CashVouchers/bystore", $"?storeid={Setting.StoreCode}");
            modeList = await Helper.FetchOptionsAsync("TransactionModes", "");
        }
        catch (Exception exception)
        {
            // exception.Redirect();
            Helper.Msg("Error", exception.Message, true);
        }

    }

}