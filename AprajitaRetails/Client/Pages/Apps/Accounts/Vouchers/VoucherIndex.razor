@page "/vouchers"

@inherits AprajitaRetails.Client.Shared.Test.IndexView

@using AprajitaRetails.Shared.Models.Vouchers;
@using Microsoft.AspNetCore.Authorization;
@using Syncfusion.Blazor.Grids
@using System.Globalization;
@using AprajitaRetails.Shared.AutoMapper.DTO
@using AprajitaRetails.Commons
 
@using Microsoft.AspNetCore.Components.WebAssembly.Authentication
@using AprajitaRetails.Shared
@using AprajitaRetails.Client.Helpers
@using AprajitaRetails.Shared.ViewModels
 
@using AprajitaRetails.Aks
@using System.Reflection

@attribute [Authorize]

@inject DataHelper Helper
@inject ClientSetting Setting
@inject NavigationManager NavigationManager

<EntityGridIndex TItem="VoucherDTO" Title="Vouchers" Columns="@GridCols"
                 Baseurl="/vouchers" CommandClicked="OnCommandClicked"
                 @bind-Entities="@entities" @bind-GroupedColumn="@GroupedColumn" Grouping=true></EntityGridIndex>

@code {

    private List<VoucherDTO>? entities;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            GroupedColumn = new string[] { "VoucherType" };
            InitView();
            await FetchDataAsync();
            GenerateColums(typeof(VoucherDTO).GetProperties(), "VoucherNumber");
            StateHasChanged();
            base.OnInitialized();
        }
        catch (Exception exception)
        {

            Helper.Msg("Error On Init", exception.Message, true);
        }

    }

    async Task<List<VoucherDTO>?> FetchDataAsync()
    {
        entities = await Helper.FetchAsync<VoucherDTO>($"api/Vouchers/bystoredto", $"?storeid={Setting.StoreCode}");
        return entities;

    }
    public void OnCommandClicked(CommandClickEventArgs<VoucherDTO> args)
    {
        // Perform required operations here.
       

        if (args.CommandColumn.Type == CommandButtonType.None && args.CommandColumn.Title == "Edit")
        {

             NavigationManager.NavigateTo($"/vouchers/Edit/true/{args.RowData.VoucherNumber}");
        }
        else if (args.CommandColumn.Type == CommandButtonType.None && args.CommandColumn.Title == "Delete")
        {
           //TODO: Make Detail page to handle delete request.
           //TODO: or Show Custom Dialog to show detail and ask confirmation for delete.
           //TODO: implement both for Better intergation

            NavigationManager.NavigateTo($"/vouchers/Detail/{args.RowData.VoucherNumber}");
        }
        else if (args.CommandColumn.Type == CommandButtonType.None && args.CommandColumn.Title == "Detail")
        {

             NavigationManager.NavigateTo($"/Vouchers/Detail/{args.RowData.VoucherNumber}");
        }
        else
        {
            Helper.Msg("Error", "This function is not enabled!", true);
        }
    }

}


